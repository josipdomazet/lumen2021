---
title: "EDA - Part II"
author: "Josip Domazet"
date: "4/27/2021"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This markdown is supposed to be run after eda_part_1.Rmd.
I'll focus on a lot of different aspect.

##Inconsistencies in data set
The question: is the data set granularity invoice line?

 
```{r}
dat %>% 
  filter(order_num == 1259712) %>% view()

# order_num == 514290 - order with 1 product, but 2 item lines  

# order_num == 4164713 1 product, 10 rows 

# order_num == 731696 - order with 1 product (item_code), but 4 item lines which were fully shipped with 4 separate invoices

```


Group data set by order num and check whether number of unique product is equal
to number of distinct order lines?
```{r}
dat %>% 
  group_by(order_num, num_of_unique_products_on_a_quote) %>% 
  summarise(n_order_lines = n_distinct(order_line_num),
            n_item_code = n_distinct(item_code)) -> order_lines_by_order_num
```


Check if item line can have multiple products
```{r}
sample <-
  dat %>%
  slice_sample(n = 10000) %>% 
  select(order_num) %>% 
  distinct() %>% 
  pull(order_num)

order_line_multiple_products <-
  dat %>% 
  filter(order_num %in% sample) %>% 
  group_by(order_line_num) %>% 
  summarise(n_products = n_distinct(item_code))

multiple_products_order <-
  dat %>% 
  filter(order_num %in% sample) %>% 
  group_by(order_num) %>% 
  summarise(n_products = n_distinct(item_code),
            n_order_lines = n_distinct(order_line_num))
```

order_line_num = 1004214 is example of order line number where
we have two products.

##The most popular items
TRANSPORT cost on the invoice can be the reason for 2 item codes on
a invoice line

when cleaning data, transport item is deleted since transport doesn't have
manufacturing cost (cost_of_part == 0).

```{r}
dat %>% 
  count(item_code) %>% 
  mutate(item_code = fct_reorder(item_code, n)) %>% 
  slice_max(n, n = 20) %>% 
  ggplot(aes(n, item_code)) +
  geom_col()
  
```

We see some items are far more frequent than others.
We know some of those items are items related to transport.
Transport item code is identified by having invoiced_qty_shipped and
ordered_qty equal to zero. Furthermore, cost_of_part is 0.
It should also have manufacturing_region and manufacturing_location_code NA because
transportation is not manufactured.
Insight: product_family is PF000 for transportation and other 
not really manufactured things
### PF000
```{r}
dat %>% 
  filter(product_family == "PF000") %>% 
  count(item_code, sort = TRUE) %>% 
  slice_max(n, n =10)
```

Check their gross margins and ordered quantities
```{r}
dat  %>% 
  filter(product_family == "PF000") %>% 
  ggplot(aes(ordered_qty)) +
  geom_histogram() +
  scale_x_log10()
```

```{r}
dat  %>% 
  filter(product_family == "PF000") %>% 
  count(manufacturing_region)
```
All items with product_family == "PF000" have
NA for manufacturing region implying they are not really manufactured.

```{r}
dat  %>% 
  filter(product_family == "PF000") %>% 
  count(manufacturing_location_code)
```

I see that NA and N9 are the only two locations.
Maybe the company uses N9 for special kind of items.

```{r}
dat %>% 
  filter(product_family == "PF000") %>% 
  count(make_vs_buy, sort= TRUE)
```
Not very clear with make_vs_buy column.

```{r}
dat %>% 
  filter(product_family == "PF000") %>% 
  count(born_on_date, sort = TRUE)
```
The majority of PF000 items are without born_on_date which is another
argument for statement that they are not really manufactured.

