---
title: "EDA - Part III"
author: "Josip Domazet"
date: "5/7/2021"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Is cost of part changing?
Check whether price components are changing
I'll use one specific item_code
```{r}
dat %>% filter(item_code == 23254681) %>% view("spec")
```

Maybe for multiple items?
```{r}
dat %>% filter(item_code  %in% c("1291")) %>% 
  ggplot(aes(invoice_date, cost_of_part)) +
  geom_point(aes(size = invoiced_qty_shipped), color = "red", alpha = 0.2) +
  geom_point(aes(invoice_date, invoiced_price), color = "blue")
```
we should remove invoiced_price == 0 because sometimes it's due to 
internal company policies.
But why is cost of part sometimes equal to zero? Is it also due to
internal company policies? 
Q: How can something be free to produce? 
A: Check make_vs_buy

##Undefined gross margin 
```{r}
{
dat %>% 
  filter(invoiced_price == 0 | is.na(invoiced_price) | is.na(cost_of_part)) %>% 
  nrow() } ==  {
dat %>% 
  filter(is.na(gm)) %>% 
  nrow()
  }
```
Gross margin is undefined in three cases (not mutually exclusive):
1. invoiced_price == 0 
2. invoiced_price not defined
3. cost_of_part not defined. **possible transportation! ** 

Let's check which items have undefined gross margins.
Since we're segmenting rows into gross margin buckets, 
having undefined gross margin is of no use for us.

13923 items have at least one invoice line in which they
don't have defined gross margin.
```{r}
dat %>% 
  filter(is.na(gm)) %>% 
  count(item_code, sort = TRUE) %>% 
  mutate(item_code = fct_reorder(item_code, n)) %>% 
  slice_max(n, n = 50) %>%  
  ggplot(aes(n, item_code)) +
  geom_col()
```
Top items with NA gross margin: by the number of rows:
1. BOY485-NPI (free item?!?!?!?!?!?!?!?!?)
2. /C
3. TRANSPORTKOSTEN
4. /LTI
5. SMSKID
```{r}
top_items_na_gm <- c("BOY485-NPI", "/C", "TRANSPORTKOSTEN",
                     "/LTI", "SMSKID", "LGMC-000203",
                     "LGSKID", "SAMPLE-MPCS", "SAMPLE-EACH",
                     "BOY485-SAMPLES")
```


###Transportation items
Items with biggest number of rows with undefined gross margin are
candidates for transportation items.

BOY385-NPI has 155916 rows. Almost all of them have invoiced_price equal to 0.
TRASNPOSRTKOSTEN has 7947 rows. Only 1 didn't have invoiced price equal to 0.
We can remove rows which don't have invoiced price equal to 0.
```{r}
dat %>% 
  filter(item_code == "BOY485-NPI") %>% 
  ggplot(aes(cost_of_part, invoiced_price)) +
  geom_point() 
```

```{r}
dat %>% 
  filter(item_code == "TRANSPORTKOSTEN") %>% 
  ggplot(aes(cost_of_part, invoiced_price)) +
  geom_point()
# one and only one row doesn't have invoiced_price equal to 0
```

```{r}
dat %>% 
    filter(item_code %in% top_items_na_gm) %>% 
  group_by(item_code) %>%
  summarise(total_rows = n(),
            cost_of_part_na = sum(cost_of_part == 0 | is.na(cost_of_part)),
            mean_cost_of_part = mean(cost_of_part, na.rm = TRUE),
            pct_cost_of_part_na = cost_of_part_na / total_rows,
            ordered_qty = sum(ordered_qty == 0 | is.na(ordered_qty)),
            pct_ordered_qty_na = ordered_qty / total_rows,
            make_vs_buy_na = sum(is.na(make_vs_buy)),
            pct_make_vs_buy_na = make_vs_buy_na / total_rows,
            born_on_date_na = sum(is.na(born_on_date)),
            pct_born_on_date_na = born_on_date_na / total_rows,
            product_group_na = sum(is.na(product_group)),
            pct_product_group_by = product_group_na / total_rows
            ) %>% 
  arrange(desc(total_rows)) %>% 
  select(item_code, total_rows, pct_cost_of_part_na, pct_ordered_qty_na,
         pct_make_vs_buy_na, pct_born_on_date_na, pct_product_group_by)
```

TRANSPORTKOSTEN has defined ordered quantities, but "/C" and "/LTI" don't.
Furthermore, TRANSPORTKOSTEN has NA for make_vs_buy, while /C and /LTI have
make_vs_buy as MANUFACTURED.
##Gross margin greater than 1
It doesn't make sense.
Either:
- negative cost_of_part (somebody paid the company to produce)
- negative invoiced_price (the company paid someone to buy)

Only 96 data set rows have gm greater than 1.
0.074 promil

##Negative gross margins

It happens when the invoiced price is far smaller than
cost of part.

8.6% of rows have negative gross margin.
```{r}
dat %>% 
  filter(gm < 0) %>% 
  mutate(shipped_bin = ggplot2::cut_number(invoiced_qty_shipped, n = 10)) %>% 
  ggplot(aes(cost_of_part, invoiced_price, color = shipped_bin)) + 
  geom_point() +
  labs(
    x = "Cost of part",
    y = "Invoiced price"
  )

# (cost_of_part, invoiced_price)
# (65316.07, 65038)
```

## Gross margin by customer region
```{r}
{
dat %>%
  filter(!is.na(customer_region)) %>% 
  filter(between(gm, 0, 1)) %>% 
    filter(invoiced_price != cost_of_part) %>% 
  ggplot(aes(gm, customer_region, fill = customer_region)) +
  geom_density_ridges(stat = "binline",
                      scale = 0.9,
                      bins = 20,
                      alpha = 0.5,
                      show.legend = FALSE) +
  labs(
    x = "Gross margin",
    y = NULL
  ) + 
  theme(text = element_text(size = 6),
        plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")) +
              scale_fill_manual(
    values = c("Europe" = hue_pal()(4)[1],
               "Asia" = hue_pal()(4)[2],
               "North America" = hue_pal()(4)[3],
               "(Missing)" = hue_pal()(4)[4]
    ))
  
} %>% 
          ggsave(filename = "..plots/gm_by_customer_region_ridge.pdf", 
         width = 6,
         height = 6,
         units = "cm",
         dpi = 300,
         device = pdf)
```

Repeat, wbuth with cost_of_part > 0
```{r}
{
dat %>%
  filter(!is.na(customer_region)) %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(cost_of_part > 0) %>% 
  ggplot(aes(gm, customer_region, fill = customer_region)) +
  geom_density_ridges(stat = "binline",
                      scale = 0.9,
                      bins = 20,
                      alpha = 0.5,
                      show.legend = FALSE) +
  labs(
    x = "Gross margin",
    y = NULL
  ) + 
  theme(text = element_text(size = 6),
        plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")) +
          scale_fill_manual(
    values = c("Europe" = hue_pal()(4)[1],
               "Asia" = hue_pal()(4)[2],
               "North America" = hue_pal()(4)[3],
               "(Missing)" = hue_pal()(4)[4]
    ))
  
} %>% 
          ggsave(filename = "..plots/gm_by_customer_region_ridge_rm_zero_cost.pdf", 
         width = 6,
         height = 6,
         units = "cm",
         dpi = 300,
         device = pdf)
```

Check if Europe has normal distribution
```{r}
europe_gm <- tibble(gm = europe_gm)
{
europe_gm %>% 
  filter(gm != 0) %>% 
  ggplot(aes(gm)) +
  geom_histogram(aes(y= ..density..), 
                 fill = hue_pal()(2)[2],
                 alpha = 0.35) +
    stat_function(fun = dnorm, n = 101, args = list(mean = 0.5, sd = 0.21),
                  color = hue_pal()(2)[1])
  
}
```
The Europe definitely resembles normal distribution ~ N(0.5, 0.21)

```{r}
{
dat %>%
  filter(!is.na(customer_region)) %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(cost_of_part > 0) %>% 
  filter(invoiced_price != cost_of_part) %>% 
  ggplot(aes(gm, customer_region, fill = customer_region)) +
  geom_density_ridges(stat = "binline", 
                      bins = 20,
                      scale = 0.9, alpha = 0.5,
                      show.legend = FALSE) +
  labs(
    x = "Gross margin",
    y = NULL
  ) + 
      scale_fill_manual(
    values = c("Europe" = hue_pal()(4)[1],
               "Asia" = hue_pal()(4)[2],
               "North America" = hue_pal()(4)[3],
               "(Missing)" = hue_pal()(4)[4]
    )) +
  theme(text = element_text(size = 6),
        plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm"))
} %>% 
          ggsave(filename = "..plots/gm_by_customer_region_ridge_rm_zero_cost_positive_gm.pdf", 
         width = 6,
         height = 6,
         units = "cm",
         dpi = 300,
         device = pdf)
```

Approximate North America and Europe with normal distribution

North America:
```{r}
{
dat %>%
  filter(!is.na(customer_region)) %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(cost_of_part > 0) %>%  # gm < 01.00
  filter(invoiced_price != cost_of_part) %>%  #  gm > 0
  filter(customer_region == "North America") %>% 
  ggplot(aes(gm)) +
  geom_histogram(aes(y = ..density..), fill = hue_pal()(4)[3], alpha = 0.3) +
  stat_function(fun = dnorm, n = 101, args = list(mean = 0.4, sd = 0.198),
                color = hue_pal()(2)[1],
                linetype = 2) +
theme(text = element_text(size = 6),
      plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")) 
} %>% 
            ggsave(filename = "..plots/gm_north_america_normal.pdf", 
         width = 5,
         height = 5,
         units = "cm",
         dpi = 300,
         device = pdf)
  
```
Europe:
```{r}
{
dat %>%
  filter(!is.na(customer_region)) %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(cost_of_part > 0) %>% 
  filter(invoiced_price != cost_of_part) %>% 
  filter(customer_region == "Europe") %>% 
  ggplot(aes(gm)) +
  geom_histogram(aes(y = ..density..), fill = hue_pal()(4)[3], alpha = 0.3) +
  stat_function(fun = dnorm, n = 101, args = list(mean = 0.48, sd = 0.21),
                color = hue_pal()(2)[1],
                linetype = 2) +
theme(text = element_text(size = 6),
      plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")) 
} %>% 
            ggsave(filename = "..plots/gm_europe_normal.pdf", 
         width = 5,
         height = 5,
         units = "cm",
         dpi = 300,
         device = pdf)
  
```

What with Asia?
```{r}
dat %>%
  filter(!is.na(customer_region)) %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(cost_of_part > 0) %>% 
  filter(invoiced_price != cost_of_part) %>% 
  filter(customer_region == "Asia") %>% 
  ggplot(aes(gm)) +
  geom_histogram(aes(y = ..density..), bins = 20, fill = hue_pal()(4)[3], alpha = 0.3) +
  stat_function(fun = dnorm, n = 101, args = list(mean = 0.25, sd = 0.15),
                color = hue_pal()(2)[1],
                linetype = 2) 
```

### Why Asia has smaller gross margin? Compare with quantity!!!
```{r}
dat %>%
  filter(!is.na(customer_region)) %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(cost_of_part > 0) %>%
  filter(ordered_qty > 0) %>% 
  ggplot(aes(gm)) +
  geom_histogram(aes(y = ..density..)) +
  #scale_x_log10() + 
  facet_wrap(~customer_region)
  
```

It turns out that gross margin Asia can also look like normal distribution
```{r}
{
  dat %>%
    filter(!is.na(customer_region)) %>% 
    filter(between(gm, 0, 1)) %>% 
    filter(cost_of_part > 0) %>%
    filter(ordered_qty > 0) %>% 
    filter(invoiced_price != cost_of_part) %>% 
    filter(customer_region == "Asia") %>% 
    filter(intercompany != "YES") %>% 
    filter(top_customer_group != "STAR") %>% 
    ggplot(aes(gm)) +
    geom_histogram(aes( y = ..density.. ), alpha = 0.4, fill = hue_pal()(2)[2]) +
    stat_function(fun = dnorm, n = 101, args  = list(mean = 0.342, sd = 0.206),
                  color = hue_pal()(2)[1],
                  linetype = 2)  +
    facet_wrap(~ intercompany) +
    theme(text = element_text(size = 6),
          plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")) +
    labs(
      x = "Gross margin",
      y = "Density"
    )
} %>% 
  ggsave(filename = "..plots/gm_asa_normal_remove_ic_s.pdf", 
         width = 3,
         height = 3,
         units = "cm",
         dpi = 300,
         device = pdf)
```

Difference in gross margin between intercompany and non-intercomapny 
for Asia
```{r}
{
  dat %>%
    filter(!is.na(customer_region)) %>% 
    filter(between(gm, 0, 1)) %>% 
    filter(cost_of_part > 0) %>%
    filter(ordered_qty > 0) %>% 
    filter(invoiced_price != cost_of_part) %>% 
    filter(customer_region == "Asia") %>% 
    #filter(intercompany != "YES") %>% 
    filter(top_customer_group != "STAR") %>% 
    mutate(intercompany = if_else(intercompany == "YES", "intercompany",
           "not intercompany")) %>% 
    ggplot(aes(gm)) +
    geom_histogram(aes( y = ..density.. ), alpha = 0.4, fill = hue_pal()(2)[2]) +
    #stat_function(fun = dnorm, n = 101, args  = list(mean = 0.342, sd = 0.206),
    #              color = hue_pal()(2)[1],
    #              linetype = 2)  +
    facet_wrap(~ intercompany) +
    theme(text = element_text(size = 6),
          plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")) +
    labs(
      x = "Gross margin",
      y = "Density"
    )
} %>% 
  ggsave(filename = "..plots/gm_asia_intercompany_vs_not_intercomapny.pdf", 
         width = 5,
         height = 5,
         units = "cm",
         dpi = 300,
         device = pdf)
```


## GM by customer industry
```{r}
{
dat %>%
  filter(!is.na(customer_industry)) %>% 
  #filter(between(gm, 0, 1)) %>% 
  filter(gm > 0 & gm < 1) %>% 
  ggplot(aes(gm)) +
  geom_histogram(fill = hue_pal()(2)[2], alpha = 0.7) +
    facet_wrap(~ customer_industry, ncol = 3, scale = "free_y") +
  theme(text = element_text(size = 6),
        plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")) +
    labs(
      x = "Gross margin", 
      y = "Count"
    )
} %>% 
          ggsave(filename = "..plots/gm_by_customer_industry_hist.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)
```

Sorted boxplots
```{r}
{
  dat %>%
    filter(!is.na(customer_region)) %>% 
    filter(between(gm, 0, 1)) %>% 
    filter(gm > 0 & gm < 1) %>% 
    filter(invoiced_qty_shipped > 0) %>% 
    mutate(customer_industry = fct_reorder(customer_industry, gm)) %>% 
    ggplot(aes(x = customer_industry, y = gm, fill = customer_industry)) +
    geom_boxplot(show.legend = FALSE, alpha = 0.7,
                 outlier.alpha = 0.05) +
    theme(text = element_text(size = 6),
          plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")) +
    labs(
      x = "Customer industry", 
      y = "Gross margin"
    )
} %>% 
  ggsave(filename = "..plots/gm_by_customer_industry_boxplots.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)

```
Sorted boxplots + remove intercompany
```{r}
{
  dat %>%
    filter(!is.na(customer_region)) %>% 
    filter(intercompany != "YES") %>% 
    filter(gm > 0 & gm < 1) %>% 
    filter(invoiced_qty_shipped > 0) %>% 
    mutate(customer_industry = fct_reorder(customer_industry, gm)) %>% 
    ggplot(aes(x = customer_industry, y = gm, fill = customer_industry)) +
    geom_boxplot(show.legend = FALSE, alpha = 0.7,
                 outlier.alpha = 0.05) +
    theme(text = element_text(size = 6),
          plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")) +
    labs(
      x = "Customer industry", 
      y = "Gross margin"
    )
} %>% 
  ggsave(filename = "..plots/gm_by_customer_industry_boxplots_no_intercompany.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)

```


Sorted boxplots + facet wrap by customer region
```{r}
{
  dat %>%
    filter(intercompany != "YES") %>% 
    filter(!is.na(customer_region)) %>% 
    filter(between(gm, 0, 1)) %>% 
    filter(cost_of_part > 0) %>%
    filter(invoiced_qty_shipped > 0) %>% 
    mutate(color_factor = as.character(customer_industry)) %>% 
    mutate(customer_industry = reorder_within(customer_industry, gm, customer_region)) %>% 
    ggplot(aes(x = customer_industry, y = gm, fill = color_factor)) +
    geom_boxplot(show.legend = FALSE, alpha = 0.7,
                 outlier.alpha = 0.05) +
    theme(text = element_text(size = 6),
          plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")) +
    labs(
      x = "Customer industry", 
      y = "Gross margin"
    ) +
    scale_x_reordered() +
    facet_wrap(~ customer_region, nrow = 3, scale = "free_x")
} %>% 
  ggsave(filename = "..plots/gm_by_customer_industry_boxplots_by_customer_region.pdf", 
         width = 8,
         height = 10,
         units = "cm",
         dpi = 300,
         device = pdf)
```


## Gross margin by product family
```{r}
{
dat %>%
  filter(!is.na(product_family)) %>% 
     filter(!is.na(customer_region)) %>% 
    filter(between(gm, 0, 1)) %>% 
    filter(cost_of_part > 0) %>%
    filter(invoiced_qty_shipped > 0) %>% 
  ggplot(aes(gm, product_family, fill = product_family)) +
  geom_density_ridges(stat = "binline", scale = 0.95, alpha = 0.5,
                      show.legend = FALSE) +
  labs(
    x = "Gross margin",
    y = "Product family"
  ) + 
  theme(text = element_text(size = 6),
        plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm")
        )
} %>% 
          ggsave(filename = "..plots/gm_by_product_family_ridge.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)
```

## Calc profit for each line
```{r}
{
dat %>%
  filter(!is.na(product_family)) %>% 
     filter(!is.na(customer_region)) %>% 
    filter(gm > 0 & gm < 1) %>% 
    filter(invoiced_qty_shipped > 0) %>% 
  mutate(revenue = invoiced_qty_shipped * (invoiced_price - cost_of_part)) %>% 
  filter_var_percent(revenue, 0.001) %>%  
  ggplot(aes(revenue)) +
  geom_histogram(
    bins = 50,
    fill = hue_pal()(2)[2], 
    alpha = 0.6
    ) +
  scale_y_continuous(labels = scales::label_number_si()) +
  labs(
    x = "Revenue of invoice line",
    y = "Count"
  ) +
  scale_x_continuous(trans = scales::log1p_trans(), 
                       labels = scales::label_number_si(),
                     breaks = c(0, 10**seq(0, 10)),
                     minor_breaks = FALSE) +
  theme(text = element_text(size = 6),
          plot.margin = grid::unit(c(2, 1, 2, 2), "mm")) 
  }
          ggsave(filename = "..plots/revenue_invoice_line.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)
  
```
Profit correlated with invoice line
```{r}
dat %>%
  filter(!is.na(product_family)) %>% 
     filter(!is.na(customer_region)) %>% 
    filter(between(gm, 0, 1)) %>% 
    filter(cost_of_part > 0) %>%
    filter(invoiced_qty_shipped > 0) %>% 
  mutate(profit = invoiced_qty_shipped * (invoiced_price - cost_of_part)) %>% 
  filter_var_percent(profit, 0.01) %>%  
  filter_var_percent(invoiced_qty_shipped, 0.01) %>% 
  sample_frac(0.1) %>% 
  ggplot(aes(gm, profit)) +
  geom_hex() +
  scale_y_continuous(trans = scales::log1p_trans()) +
```


## Gross margin dependent on binned quantity


```{r}
dat %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(ordered_qty > 0) %>% 
  mutate(qty_bin = case_when(
    ordered_qty > 0 & ordered_qty < 10 ~ "between 0 and 10",
    between(ordered_qty, 10, 100) ~ "between 10 and 100",
    between(ordered_qty, 100, 1000) ~ "between 100 and 1000",
    ordered_qty > 1000 ~ "more than 1000"
  )) %>% 
  ggplot(aes(qty_bin, gm)) +
    geom_boxplot() +
  labs(
    x = "Quantity bin",
    y = "Gross margin"
  )
```


```{r}
{
dat %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(ordered_qty > 0) %>% 
  filter(invoiced_qty_shipped > 0 ) %>%  # Transportation
  mutate(qty_bin = case_when(
    invoiced_qty_shipped > 0 & invoiced_qty_shipped < 10 ~ "between 0 and 10",
    between(invoiced_qty_shipped, 10, 100) ~ "between 10 and 100",
    between(invoiced_qty_shipped, 100, 1000) ~ "between 100 and 1000",
    between(invoiced_qty_shipped, 1000, 10000) ~ "between 1000 and 10000",
    invoiced_qty_shipped > 10000 ~ "more than 10000"
  )) %>% 
  ggplot(aes(qty_bin, gm)) +
  geom_boxplot(aes(fill = qty_bin), alpha = 0.6, show.legend = FALSE) +
  labs(
    x = "Shipped quantity bin",
    y = "Gross margin"
  ) +
    theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm"))
} %>% 
      ggsave(filename = "..plots/gm_by_binned_shipped_qty.pdf", 
      width = 8,
      height = 8,
      units = "cm",
      dpi = 300,
      device = pdf)
```

## Economy of scale (fixed item, increased quantity)

Item code *200001
```{r}
dat %>% 
  group_by(item_code) %>% 
  summarise(price_sd = sd(invoiced_price, na.rm = TRUE),
            cost_of_part_sd = sd(cost_of_part, na.rm = TRUE),
            qty_sd = sd(ordered_qty, na.rm = TRUE),
            median_qty = median(ordered_qty, na.rm = TRUE),
            median_price  = median(invoiced_price, na.rm = TRUE),
            n_customers = n_distinct(customer_id)) %>% 
  arrange(desc(price_sd)) -> items_by_price_sd

items_by_price_sd %>% 
  ggplot(aes(median_qty, price_sd)) +
  geom_point() +
  
```

After choosing item code
```{r}
# OK: 180037
# GREAT: CP30G01, 005999
{
  dat %>% 
  filter(item_code %in%  c("CP30G01")) %>% 
  mutate(item_code = paste0("Item ", item_code)) %>% 
  filter(invoiced_price != 0) %>% 
    group_by(item_code) %>% 
  ggplot(aes(invoiced_qty_shipped, invoiced_price, color = item_code)) + 
  geom_point(show.legend = FALSE, alpha = 0.5) +
  #geom_text(aes(label = round(gm, 2)), size = 4) +
  labs(
    x = "Invoiced quantity",
    y = "Invoiced price"
  ) +
  facet_wrap(~ item_code, scale = "free") +
  theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 1.0, 2, 2), "mm"))
  } %>% 
        ggsave(filename = "..plots/same_item_diff_price_qty.pdf", 
      width = 8,
      height = 8,
      units = "cm",
      dpi = 300,
      device = pdf)
```
**Economy of scale** - gm + invoiced quantity + invoiced price
Chosen item!
```{r}
{
  dat %>% 
  filter(item_code %in%  c("CP30G01")) %>% 
  mutate(item_code = paste0("Item ", item_code)) %>% 
  filter(invoiced_price != 0) %>% 
  mutate(qty_bin = case_when(
    between(invoiced_qty_shipped, 0, 7) ~ 5,  #"low",
    between(invoiced_qty_shipped, 7, 30) ~ 25,# "medium",
    invoiced_qty_shipped > 30 ~ 50 # "high" 
  )) %>% 
  ggplot(aes(qty_bin, gm)) + 
  #geom_point(show.legend = FALSE, alpha = 0.5) +
    geom_boxplot(aes(qty_bin, gm, group = qty_bin),
                 width = 15,
                 fill = hue_pal()(2)[2], alpha = 0.5) +
  #geom_text(aes(label = round(gm, 2)), size = 4) +
  labs(
    x = "Invoiced quantity",
    y = "Gross margin",
    title = "Item code CP30G01"
  ) +
  scale_x_continuous(breaks = seq(0, 56, 10),
                     minor_breaks = NULL) + 
  theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 1.0, 2, 2), "mm"))
  } %>% 
        ggsave(filename = "..plots/lower_gm_higher_qty.pdf", 
      width = 8,
      height = 8,
      units = "cm",
      dpi = 300,
      device = pdf)
```

Calculate profit - mean
```{r}
  dat %>% 
  filter(item_code %in%  c("CP30G01")) %>% 
  mutate(item_code = paste0("Item ", item_code)) %>% 
  filter(invoiced_price != 0) %>% 
  mutate(qty_bin = case_when(
    between(invoiced_qty_shipped, 0, 7) ~ 5,  #"low",
    between(invoiced_qty_shipped, 7, 30) ~ 25,# "medium",
    invoiced_qty_shipped > 30 ~ 50 # "high" 
  )) %>% 
  group_by(qty_bin) %>%
  summarise(profit = mean((invoiced_qty_shipped *
                            (invoiced_price - cost_of_part)),
            na.rm = TRUE))
          
```

Calculate profit - boxplot
```{r}
{ 
  dat %>% 
  filter(item_code %in%  c("CP30G01")) %>% 
  mutate(item_code = paste0("Item ", item_code)) %>% 
  filter(invoiced_price != 0) %>% 
  mutate(qty_bin = case_when(
    between(invoiced_qty_shipped, 0, 7) ~ 5,  #"low",
    between(invoiced_qty_shipped, 7, 30) ~ 25,# "medium",
    invoiced_qty_shipped > 30 ~ 50 # "high" 
  )) %>% 
  ggplot(aes(qty_bin,
             invoiced_qty_shipped *
                          (invoiced_price - cost_of_part),
             group = qty_bin)) +
  geom_boxplot(width = 15,
                 fill = hue_pal()(2)[1], alpha = 0.6) +
  labs(
    x = "Invoiced quantity",
    y = "Profit",
    title = "Item code CP30G01"
  ) +
    annotate("text",
             size = 2,
             x = 5, 
             y = 4750, 
             label = 
               unname(TeX(c("$gm = 0.595$")))) +
        annotate("text",
                 size = 2,
             x = 25, 
             y = 6250, 
             label = 
               unname(TeX(c("$gm = 0.356$")))) +
    annotate("text",
             size = 2,
             x = 50, 
             y = 10550, 
             label = 
               unname(TeX(c("$gm = 0.154$")))) +
    ylim(0, 11500) +
   theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 1.0, 2, 2), "mm"))
  } %>% 
          ggsave(filename = "..plots/higher_qty_higher_profit_with_gm.pdf", 
      width = 8,
      height = 8,
      units = "cm",
      dpi = 300,
      device = pdf)
  
```



```{r}
{dat %>% 
  filter(item_code %in%  c("CP30G01", "000871", "005999")) %>% 
  mutate(item_code = paste0("Item ", item_code)) %>% 
  filter(invoiced_price != 0) %>% 
  ggplot(aes(invoiced_qty_shipped, cost_of_part, color = item_code)) + 
  geom_point(show.legend = FALSE) +
  labs(
    x = "Invoiced quantity",
    y = "Invoiced price"
  ) +
  facet_wrap(~ item_code, scale = "free") +
  theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 1.0, 2, 2), "mm"))
  } %>% 
        ggsave(filename = "..plots/same_item_diff_price_qty.pdf", 
      width = 8,
      height = 8,
      units = "cm",
      dpi = 300,
      device = pdf)
```


## Gross margin dependent on binned invoice price
```{r}

```

Boxplot
```{r}
{
dat %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(cost_of_part > 0) %>% 
  filter(invoiced_qty_shipped > 0) %>% 
  mutate(price_bin = case_when(
    invoiced_price > 0 & invoiced_price < 10 ~ "between 0 and 10",
    between(invoiced_price, 10, 100) ~ "between 10 and 100",
    between(invoiced_price, 100, 1000) ~ "between 100 and 1000",
    invoiced_price > 1000 ~ "more than 1000"
  )) %>% 
  ggplot(aes(price_bin, gm)) +
    geom_boxplot(aes(fill = price_bin),
                 alpha = 0.6,
                 show.legend = FALSE) +
  labs(
    x = "Price bin",
    y = "Gross margin"
  ) + 
  theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm"))
} %>% 
        ggsave(filename = "..plots/gm_by_binned_price_box_all.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 250,
         device = pdf)
```

Ridge
```{r}
{
dat %>% 
  filter(between(gm, 0, 1)) %>% 
    filter(!is.na(invoiced_price)) %>% 
    filter(invoiced_price >= 0) %>% 
    filter(invoiced_qty_shipped >= 0) %>% 
  mutate(price_bin = case_when(
    invoiced_price >= 0 & invoiced_price < 10 ~ "between 0 and 10",
    between(invoiced_price, 10, 100) ~ "between 10 and 100",
    between(invoiced_price, 100, 1000) ~ "between 100 and 1000",
    invoiced_price > 1000 ~ "more than 1000"
  )) %>% 
  ggplot(aes(gm, price_bin)) +
    geom_density_ridges(fill =  hue_pal()(2)[2],
                        alpha = 0.6,
                        show.legend = FALSE) +
  labs(
    y = "Price bin",
    x = "Gross margin"
  ) + 
  theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm"))
} %>% 
        ggsave(filename = "..plots/gm_by_binned_price_ridge.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)
```

Fraction of Gross Margin exactly equal to one
```{r}
dat %>% 
  filter(between(gm, 0, 1)) %>% 
   mutate(price_bin = case_when(
    invoiced_price > 0 & invoiced_price < 10 ~ "between 0 and 10",
    between(invoiced_price, 10, 100) ~ "between 10 and 100",
    between(invoiced_price, 100, 1000) ~ "between 100 and 1000",
    invoiced_price > 1000 ~ "more than 1000"
   ))  %>% 
  group_by(price_bin) %>% summarise(sum(gm == 1) / n())

```


```{r}
dat %>% 
  filter(between(gm, 0, 1)) %>% 
   mutate(price_bin = case_when(
    invoiced_price > 0 & invoiced_price < 10 ~ "between 0 and 10",
    between(invoiced_price, 10, 100) ~ "between 10 and 100",
    between(invoiced_price, 100, 1000) ~ "between 100 and 1000",
    invoiced_price > 1000 ~ "more than 1000"
   ))  %>% 
  filter(!is.na(product_group)) %>% 
  ggplot(aes(price_bin, gm)) +
  geom_boxplot() +
  facet_wrap(~  product_group)
```


## Cost of part dependent on binned invoice price
```{r}
{
dat %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(invoiced_price > 0) %>% 
    filter(invoiced_qty_shipped > 0) %>% 
  #filter(cost_of_part > 0) %>%  # dodano
  mutate(price_bin = case_when(
    invoiced_price > 0 & invoiced_price < 10 ~ "between 0 and 10",
    between(invoiced_price, 10, 100) ~ "between 10 and 100",
    between(invoiced_price, 100, 1000) ~ "between 100 and 1000",
    invoiced_price > 1000 ~ "more than 1000"
  )) %>%
    filter_var_percent(cost_of_part, 0.01) %>% 
  group_by(price_bin, item_code) %>% 
  summarise(cost_of_part = mean(cost_of_part, na.rm = TRUE),
            shipped_qty = mean(invoiced_qty_shipped, na.rm = TRUE),
            invoiced_price = mean(invoiced_price, na.rm = TRUE),
            gm = mean(gm, na.rm = TRUE)) %>% 
  ungroup() %>% 
    filter_percent(cost_of_part, 0.01) %>% 
  ggplot(aes(price_bin, cost_of_part)) +
     geom_boxplot(aes(fill = price_bin),
                  alpha = 0.6,
                  show.legend = FALSE) +
  labs(
    x = "Price bin",
    y = "Cost of part"
  ) + 
  scale_y_continuous(
    trans = scales::log1p_trans(),
    labels = scales::label_number_si(),
    breaks = c(0, 10**seq(0, 10)),
    minor_breaks = FALSE) +
  theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm"))
} %>% 
        ggsave(filename = "..plots/cost_of_part_by_binned_price_box_all.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)
```

## Gross margin by price bin with positive unit cost
```{r}
{
  dat %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(cost_of_part > 0) %>% 
  filter(invoiced_qty_shipped > 0) %>% 
  mutate(price_bin = case_when(
    invoiced_price > 0 & invoiced_price < 10 ~ "between 0 and 10",
    between(invoiced_price, 10, 100) ~ "between 10 and 100",
    between(invoiced_price, 100, 1000) ~ "between 100 and 1000",
    invoiced_price > 1000 ~ "more than 1000"
  )) %>% 
  ggplot(aes(price_bin, gm)) +
    geom_boxplot(aes(fill = price_bin),
                 alpha = 0.6,
                 show.legend = FALSE) +
  labs(
    x = "Price bin",
    y = "Gross margin"
  ) + 
  theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm"))
} %>% 
        ggsave(filename = "..plots/gm_by_binned_price_box_positive_unit_cost.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)
```


## Invoice lines binned by price and customer age
```{r}
dat %>% 
  mutate(
    customer_age =
      case_when(
        year(customer_first_invoice_date) %in% 2016:2021 ~ "new",
        year(customer_first_invoice_date) %in% 2010:2015 ~ "medium",
        year(customer_first_invoice_date) < 2010 ~ "old"
      )
  ) %>% 
  mutate(profit = (invoiced_qty_shipped *
                            (invoiced_price - cost_of_part))) %>% 
  filter_var_percent(profit, 0.05) %>% 
  mutate(customer_age = fct_reorder(customer_age, profit)) %>% 
  ggplot(aes(profit, customer_age)) +
  geom_density_ridges()
  labs(
    x  = "Customer age bin",
    y = "Profit"
  )
  
  
```

Customer age - gross margin
```{r}
dat %>% 
  mutate(
    customer_age =
      case_when(
        year(customer_first_invoice_date) %in% 2016:2021 ~ "new",
        year(customer_first_invoice_date) %in% 2010:2015 ~ "medium",
        year(customer_first_invoice_date) < 2010 ~ "old"
      )
  ) %>% 
  filter(cost_of_part == 0) %>% 
  count(customer_age)
  filter(between(gm, 0, 1)) %>% 
  ggplot(aes(gm, fill = customer_age)) +
  geom_histogram(show.legend = FALSE) +
  facet_wrap(~ customer_age)
  labs(
    x  = "Customer age bin",
    y = "Profit"
  )
```


```{r}
dat %>% 
  mutate(profit = (invoiced_qty_shipped *
                            (invoiced_price - cost_of_part))) %>% 
  filter_var_percent(profit, 0.05) %>% 
  filter_var_percent(gm, 0.05) %>% 
  #mutate(customer_industry = fct_reorder(customer_industry, profit)) %>% 
  ggplot(aes(gm, profit)) +
  geom_point()
```


## Quantity and price 
Are customers ordering high priced items in large quantity?
```{r}
{dat %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(invoiced_price > 0) %>%
  filter(invoiced_qty_shipped > 0) %>%
  filter_percent(invoiced_price, 0.025) %>% 
  group_by(item_code, product_family, customer_industry, make_vs_buy) %>% 
  summarise(cost_of_part = mean(cost_of_part, na.rm = TRUE),
            shipped_qty = mean(invoiced_qty_shipped, na.rm = TRUE),
            invoiced_price = mean(invoiced_price, na.rm = TRUE),
            gm = mean(gm, na.rm = TRUE)) %>% 
  ungroup() %>% 
    ggplot(aes(invoiced_price, shipped_qty)) +
    geom_point(alpha = 0.2, show.legend = FALSE,
               color = hue_pal()(2)[2]) +
  labs(
    y = "Shipped quantity",
    x = "Invoiced price"
  ) + 
  scale_y_log10(labels = scales::label_number_si()) +
  theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm"))
} %>% 
        ggsave(filename = "..plots/scatter_price_quantity.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)
```

## Shipped Quantity - Invoiced price, outliers
```{r}

{dat %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(invoiced_price > 0) %>%
  filter(invoiced_qty_shipped > 0) %>% 
  mutate(make_vs_buy = case_when(
    make_vs_buy %in% c("BUY", "BUY - IMPORTED",
                       "BUY - INTERPLNT TRNS",
                       "BUY - LOCAL",
                       "PURSHASED",
                       "PURCHASED (RAW)") ~ "buy",
    make_vs_buy %in% c("FINISHED GOODS", "MANUFACTURED") ~ "make")
  ) %>%
  filter(!is.na(make_vs_buy)) %>%
  filter(cost_of_part > 0) %>%  # dodano
  mutate(price_bin = case_when(
    invoiced_price > 0 & invoiced_price < 10 ~ "between 0 and 10",
    between(invoiced_price, 10, 100) ~ "between 10 and 100",
    between(invoiced_price, 100, 1000) ~ "between 100 and 1000",
    invoiced_price > 1000 ~ "more than 1000"
  )) %>%
  filter_percent(invoiced_price, 0.025) %>% 
  group_by(item_code, product_family, customer_industry, make_vs_buy) %>% 
  summarise(cost_of_part = mean(cost_of_part, na.rm = TRUE),
            shipped_qty = mean(invoiced_qty_shipped, na.rm = TRUE),
            invoiced_price = mean(invoiced_price, na.rm = TRUE),
            gm = mean(gm, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(item_code_s = stringr::str_detect(item_code, "^[0-9]{1}-[0-9]{3}.*")) %>%
   filter(!is.na(item_code_s)) %>%
  ggplot(aes(invoiced_price, shipped_qty, color = item_code_s)) +
    ggplot(aes(invoiced_price, shipped_qty)) +
    geom_point(alpha = 0.2, show.legend = FALSE,
               color = hue_pal()(2)[1]) +
  labs(
    y = "Shipped quantity",
    x = "Invoiced price"
  ) + 
  scale_y_log10(labels = scales::label_number_si()) +
  theme(text = element_text(size = 5.5),
  plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm"))
} %>% 
        ggsave(filename = "..plots/scatter_price_quantity_special_case.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)
```

## Scatterplot

### Cost of part dependent on binned invoice price

```{r}
dat %>% 
  filter(between(gm, 0, 1)) %>% 
  filter(invoiced_price > 0) %>% 
  filter(between(cost_of_part,
                 quantile(cost_of_part, 0.05, na.rm = TRUE),
                 quantile(cost_of_part, 0.95, na.rm = TRUE))) %>% 
  mutate(price_bin = case_when(
    invoiced_price > 0 & invoiced_price < 10 ~ "between 0 and 10",
    between(invoiced_price, 10, 100) ~ "between 10 and 100",
    between(invoiced_price, 100, 1000) ~ "between 100 and 1000",
    invoiced_price > 1000 ~ "more than 1000"
  )) %>% 
  ggplot(aes(price_bin, cost_of_part)) +
    geom_boxplot() +
  labs(
    x = "Price bin",
    y = "Cost of part"
  )
```

**Note** There is a lot of expensive items (> 1000) which
have cost of part equal to 0.

### Price for items with cost of part equal to 0
```{r}
dat %>% 
  filter(cost_of_part == 0) %>%
  filter(between(invoiced_price,
                 quantile(invoiced_price, 0.05, na.rm = TRUE),
                 quantile(invoiced_price, 0.95, na.rm = TRUE))) %>% 
  ggplot(aes(invoiced_price, fill = product_family)) +
  geom_histogram(alpha = 0.2) +
  scale_x_log10() + 
  facet_wrap(~ product_family)

dat %>% 
  filter(cost_of_part > 0) %>%
  filter(between(invoiced_price,
                 quantile(invoiced_price, 0.05, na.rm = TRUE),
                 quantile(invoiced_price, 0.95, na.rm = TRUE))) %>% 
  ggplot(aes(invoiced_price)) +
  geom_histogram() +
  scale_x_log10()
```

```{r}
dat %>% 
  filter(ordered_qty > 0) %>% 
  filter(between(ordered_qty, quantile(ordered_qty, 0.01, na.rm = TRUE),
                 quantile(ordered_qty, 0.99, na.rm = TRUE))) %>% 
  ggplot(aes(ordered_qty)) +
  geom_histogram(fill = hue_pal()(2)[2], alpha = 0.75,
                 color = "black") +
  scale_x_continuous(labels = scales::label_number_si()) + 
      theme(text = element_text(size=6),
          plot.margin=grid::unit(c(2, 0.3, 2, 2), "mm")) +
  labs(
    x = "Ordered quantity",
    y = "Number of rows"
  )
  
```


# Quantities

**linear scale**
```{r}

dat %>% 
  mutate(qty_bin = case_when(
    ordered_qty < 0 ~ "negative",
    ordered_qty == 0 ~ "exactly zero",
    ordered_qty > 0 & ordered_qty < 10 ~ "between 0 and 10",
    between(ordered_qty, 10, 100) ~ "between 10 and 100",
    between(ordered_qty, 100, 1000) ~ "between 100 and 1000",
    ordered_qty > 1000 ~ "more than 1000"
  )) %>% 
  group_by(qty_bin) %>% 
  tally() %>% 
  mutate(n = 100*n / sum(n))

```

```{r}
dat %>% 
 ggplot(aes(ordered_q))
```


```{r}
{
order_line_qty_distinct %>% 
  filter(between(ordered_qty,
                 quantile(ordered_qty, 0.01, na.rm = TRUE),
                 quantile(ordered_qty, 0.99, na.rm = TRUE))) %>% 
  ggplot(aes(ordered_qty)) +
  geom_histogram(fill = hue_pal()(2)[2], alpha = 0.6,
                 size = .25, color = "black") +
  labs(
    x = "Ordered quantity",
    y = "Number of order lines"
  ) +
  scale_x_continuous(labels = scales::label_number_si()) +
  scale_y_continuous(labels = scales::label_number_si()) +
   theme(text = element_text(size=6),
        plot.margin=grid::unit(c(2, 0.3, 2, 2), "mm"))
} %>% 
          ggsave(filename = "..plots/ordered_qty_1percent_linear.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)
```

**log scale**
```{r}
{
order_line_qty_distinct %>% 
  filter(ordered_qty > 0) %>% 
  filter(between(ordered_qty,
                 quantile(ordered_qty, 0.01, na.rm = TRUE),
                 quantile(ordered_qty, 0.99, na.rm = TRUE))) %>% 
  ggplot(aes(ordered_qty)) +
  geom_histogram(fill = hue_pal()(2)[2], alpha = 0.6,
                 size = .25, color = "black") +
  labs(
    x = "Ordered quantity",
    y = "Number of order lines"
  ) +
  scale_x_continuous(
    trans = scales::log10_trans(),
    labels = scales::label_number_si()) +
  scale_y_continuous(labels = scales::label_number_si()) +
   theme(text = element_text(size=6),
        plot.margin=grid::unit(c(2, 0.3, 2, 2), "mm"))
} %>% 
          ggsave(filename = "..plots/ordered_qty_1percent_log.pdf", 
         width = 8,
         height = 8,
         units = "cm",
         dpi = 300,
         device = pdf)
```

# Sales Channels
```{r}
dat %>% 
  summarise(n_distinct(sales_channel))
```
Is there only one sales channel by order?

```{r}
dat %>% 
  select(order_num, sales_channel) %>% 
  distinct() -> sales_channel_by_order
```
Sales channel is not by order, it's by invoice.

```{r}
dat %>% 
  select(invoice_num, sales_channel) %>% 
  distinct() -> sales_channel_by_invoice

# sanity check
nrow(sales_channel_by_invoice) == summarise(dat, n_distinct(invoice_num))
```

Check for the most common sales channels
```{r}
sales_channel_by_invoice %>%
  count(sales_channel) -> sales_channel_count_by_invoice
```


# Intercompany

Check by row count
```{r}
dat %>% 
  count(intercompany)
```

Check by order count
```{r}
dat %>% 
  select(order_num, intercompany) %>% 
  distinct() -> intercompany_by_order
```

One order can be both intercompany and non-intercompany??
```{r}
dat %>%
  filter(order_num == 725393) %>% glimpse
```

# VIP and NON-vip

I'll try to find out same items for both vip and non-vip users
and compare the prices
```{r}
vip_items <- dat %>% 
  filter(top_customer_group == "STAR") %>% 
  select(top_customer_group, item_code) %>% 
  distinct()

nonvip_items <- dat %>% 
  filter(top_customer_group == "OTHER") %>% 
  select(top_customer_group, item_code) %>% 
  distinct()

```

VIP items: 3709
non-VIP items: 60046
- - - - - - - - - -
total items: 63020

There are obviously overlapping items.

```{r}
bind_rows(vip_items, nonvip_items) %>% 
  count(item_code) %>% 
  filter(n > 1) %>% 
  pull(item_code) -> overlapping_items
```

## Compare for overlapping items
```{r}
dat %>% 
  filter(item_code %in% overlapping_items) %>% 
  group_by(item_code, top_customer_group) %>% 
  summarise(avg_shipped = mean(invoiced_qty_shipped, na.rm = TRUE),
            invoiced_price = mean(invoiced_price, na.rm = TRUE)) ->
compare_overlapping

compare_overlapping %>% 
  ggplot(aes(top_customer_group, avg_shipped)) +
  geom_boxplot() +
  scale_y_log10()

compare_overlapping %>% 
  ggplot(aes(top_customer_group, invoiced_price)) +
  geom_boxplot() +
  scale_y_log10()
```

On dataset level for all items
```{r}
dat %>% 
  filter(invoiced_price > 0) %>% 
  select(top_customer_group, order_line_num, item_code, ordered_qty,
         invoiced_price) %>% 
  distinct() -> all_items_top_customer_group

all_items_top_customer_group %>% 
  filter(between(invoiced_price, quantile(invoiced_price, 0.01, na.rm = TRUE),
                 quantile(invoiced_price, 0.99, na.rm = TRUE))) %>% 
  ggplot(aes(top_customer_group, invoiced_price, fill = top_customer_group)) +
  geom_boxplot(show.legend = FALSE) +
  scale_y_log10(labels = scales::label_number_si()) +
  labs(
    x = "Customer groups",
    y = "Invoiced price"
  ) 

all_items_top_customer_group %>% 
  filter(between(ordered_qty, quantile(ordered_qty, 0.01, na.rm = TRUE),
                 quantile(ordered_qty, 0.99, na.rm = TRUE))) %>% 
  ggplot(aes(top_customer_group, ordered_qty, fill = top_customer_group)) +
  geom_boxplot(show.legend = FALSE) +
  scale_y_log10(labels = scales::label_number_si()) +
  labs(
    x = "Customer groups",
    y = "Ordered Quantity"
  ) 
```


## Example of overlapping item 1002285
This items has one STAR customer and another OTHER customer.
```{r}
dat %>%
  filter(item_code == "1002285") %>% 
  ggplot(aes(invoiced_price, cost_of_part, color = top_customer_group)) +
  geom_point(aes(size = invoiced_qty_shipped), alpha = 0.5) +
  xlim(0, 0.5) +
  ylim(0, 0.1)
```






