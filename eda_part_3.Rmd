---
title: "EDA - Part III"
author: "Josip Domazet"
date: "5/7/2021"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Is cost of part changing?
Check whether price components are changing
I'll use one specific item_code
```{r}
dat %>% filter(item_code == 23254681) %>% view("spec")
```

Maybe for multiple items?
```{r}
dat %>% filter(item_code  %in% c("1291")) %>% 
  ggplot(aes(invoice_date, cost_of_part)) +
  geom_point(aes(size = invoiced_qty_shipped), color = "red", alpha = 0.2) +
  geom_point(aes(invoice_date, invoiced_price), color = "blue")
```
we should remove invoiced_price == 0 because sometimes it's due to 
internal company policies.
But why is cost of part sometimes equal to zero? Is it also due to
internal company policies? 
Q: How can something be free to produce? 
A: Check make_vs_buy. Column. It's buy.

##Undefined gross margin 
```{r}
{
dat %>% 
  filter(invoiced_price == 0 | is.na(invoiced_price) | is.na(cost_of_part)) %>% 
  nrow() } ==  {
dat %>% 
  filter(is.na(gm)) %>% 
  nrow()
  }
```
Gross margin is undefined in three cases (not mutually exclusive):
1. invoiced_price == 0 
2. invoiced_price not defined
3. cost_of_part not defined. **possible transportation! ** 

Let's check which items have undefined gross margins.
Since we're segmenting rows into gross margin buckets, 
having undefined gross margin is of no use for us.

13923 items have at least one invoice line in which they
don't have defined gross margin.
```{r}
dat %>% 
  filter(is.na(gm)) %>% 
  count(item_code, sort = TRUE) %>% 
  mutate(item_code = fct_reorder(item_code, n)) %>% 
  slice_max(n, n = 50) %>%  
  ggplot(aes(n, item_code)) +
  geom_col()
```
Top items with NA gross margin: by the number of rows:
1. BOY485-NPI (free item?!?!?!?!?!?!?!?!?)
2. /C
3. TRANSPORTKOSTEN
4. /LTI
5. SMSKID
```{r}
top_items_na_gm <- c("BOY485-NPI", "/C", "TRANSPORTKOSTEN",
                     "/LTI", "SMSKID", "LGMC-000203",
                     "LGSKID", "SAMPLE-MPCS", "SAMPLE-EACH",
                     "BOY485-SAMPLES")
```


###Transportation items
Items with biggest number of rows with undefined gross margin are
candidates for transportation items.

BOY385-NPI has 155916 rows. Almost all of them have invoiced_price equal to 0.
TRASNPOSRTKOSTEN has 7947 rows. Only 1 didn't have invoiced price equal to 0.
We can remove rows which don't have invoiced price equal to 0.
```{r}
dat %>% 
  filter(item_code == "BOY485-NPI") %>% 
  ggplot(aes(cost_of_part, invoiced_price)) +
  geom_point() 
```

```{r}
dat %>% 
  filter(item_code == "TRANSPORTKOSTEN") %>% 
  ggplot(aes(cost_of_part, invoiced_price)) +
  geom_point()
# one and only one row doesn't have invoiced_price equal to 0
```

```{r}
dat %>% 
    filter(item_code %in% top_items_na_gm) %>% 
  group_by(item_code) %>%
  summarise(total_rows = n(),
            cost_of_part_na = sum(cost_of_part == 0 | is.na(cost_of_part)),
            mean_cost_of_part = mean(cost_of_part, na.rm = TRUE),
            pct_cost_of_part_na = cost_of_part_na / total_rows,
            ordered_qty = sum(ordered_qty == 0 | is.na(ordered_qty)),
            pct_ordered_qty_na = ordered_qty / total_rows,
            make_vs_buy_na = sum(is.na(make_vs_buy)),
            pct_make_vs_buy_na = make_vs_buy_na / total_rows,
            born_on_date_na = sum(is.na(born_on_date)),
            pct_born_on_date_na = born_on_date_na / total_rows,
            product_group_na = sum(is.na(product_group)),
            pct_product_group_by = product_group_na / total_rows
            ) %>% 
  arrange(desc(total_rows)) %>% 
  select(item_code, total_rows, pct_cost_of_part_na, pct_ordered_qty_na,
         pct_make_vs_buy_na, pct_born_on_date_na, pct_product_group_by)
```

TRANSPORTKOSTEN has defined ordered quantities, but "/C" and "/LTI" don't.
Furthermore, TRANSPORTKOSTEN has NA for make_vs_buy, while /C and /LTI have
make_vs_buy as MANUFACTURED.
## Gross margin greater than 1
It doesn't make sense.
Either:
- negative cost_of_part (somebody paid the company to produce)
- negative invoiced_price (the company paid someone to buy)

Only 96 data set rows have gm greater than 1.
0.074 promil

##Negative gross margins

It happens when the invoiced price is far smaller than
cost of part.

8.6% of rows have negative gross margin.
```{r}
dat %>% 
  filter(gm < 0) %>% 
  mutate(shipped_bin = ggplot2::cut_number(invoiced_qty_shipped, n = 10)) %>% 
  ggplot(aes(cost_of_part, invoiced_price, color = shipped_bin)) + 
  geom_point() +
  labs(
    x = "Cost of part",
    y = "Invoiced price"
  )

# (cost_of_part, invoiced_price)
# (65316.07, 65038)
```

# Quantities

```{r}
dat %>% 
  select(order_line_num, ordered_qty) %>% 
  distinct() -> order_line_qty_distinct

order_line_qty_distinct %>% 
  filter(between(ordered_qty,
                 quantile(ordered_qty, 0.01, na.rm = TRUE),
                 quantile(ordered_qty, 0.99, na.rm = TRUE))) %>% 
  ggplot(aes(ordered_qty)) +
  geom_histogram() +
  labs(
    x = "Ordered quantity",
    y = "Number of rows"
  ) +
    scale_x_log10(labels = scales::label_number_si()) +
                     theme(text = element_text(size=6),
                           plot.margin = grid::unit(c(2, 0.3, 2, 2), "mm"))
```

